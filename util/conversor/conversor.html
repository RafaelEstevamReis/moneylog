<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<title>Importar dados para o MoneyLog</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="author" content="Aurelio Marinho Jargas www.aurelio.net">
	
<script type="text/javascript">

var dataFieldSeparator = '\t';
var dataRecordSeparator = /\r?\n/;  // \r\n Windows, \n Linux/Mac
var dataTagTerminator = '|';
var dataTagSeparator = ',';
var commentChar = '#';   // Must be at line start (column 1)

String.prototype.strip = function () {
	return this.replace(/^\s+/, '').replace(/\s+$/, '');
};

function formatValue(n) {
	return (document.getElementById('usecommas').checked) ? n.replace('.', ',') : n;
}
function formatDocNumber(n) {
	return '(Doc. ' + n + ') ';
}
function formatDescription(s, doc_nr) {
	s = s.strip();
	// Prepend Doc number
	if (doc_nr && !document.getElementById('hidedocnumber').checked) {
		s = formatDocNumber(doc_nr) + s;
	}
	// lowercased
	if (document.getElementById('lowerdesc').checked) {
		s = s.toLowerCase();
	}
	return s;
}
function convertOFX(rawData) {
	var i, newline, parsedData, rowDate, rowAmount, rowDescription, rowDocNumber, transactions, matches, m;
		
	newline = /\r?\n\t*/g;  // \r\n Windows, \n Linux/Mac (plus leading TABS)
	parsedData = [];
	
	rawData = rawData.replace(newline, ''); // one big line

	transactions = rawData.match(/<BANKTRANLIST>(.*)<\/BANKTRANLIST>/);
	if (transactions) {
		transactions = transactions[1];
	} else {
		return [];
	}
	
	matches = transactions.match(/<STMTTRN>.*?<\/STMTTRN>/g);
	
	for (i = 0; i < matches.length; i++) {

		rowDate = rowAmount = rowDocNumber = rowDescription = '';
		
		// <DTPOSTED>20090801080000
		m = matches[i].match(/<DTPOSTED>(\d\d\d\d)(\d\d)(\d\d)/);
		if (m) {
			rowDate = m[1] + '-' + m[2] + '-' + m[3];
		} else {
			rowDate = 'DATA_INVÁLIDA';
		}
		
		// <TRNAMT>1234.00
		// <TRNAMT>-1234.00
		m = matches[i].match(/<TRNAMT>(-?[\d.]+)/);
		if (m) {
			rowAmount = m[1];
		} else {
			rowAmount = 'VALOR_INVÁLIDO';
		}

		// <CHECKNUM>0223456
		m = matches[i].match(/<CHECKNUM>(\d+)/);
		if (m) {
			rowDocNumber = m[1];
		} else {
			rowDocNumber = 'NUMDOC_INVÁLIDO';
		}

		// <MEMO>CORRECAO POUPANCA
		m = matches[i].match(/<MEMO>(.*?)[<]/);
		if (m) {
			rowDescription = m[1];
		}

		parsedData.push([
			rowDate,
			formatValue(rowAmount),
			formatDescription(rowDescription, rowDocNumber)
		].join(dataFieldSeparator));
	}
	return parsedData;
}
function convertQIF(rawData, version) {
	// Thanks Leslie Harlley Watter
	
	// The only difference between QIF versions are in the date format:
	// Quicken    : @@@D12/31'09
	// MS Money 97: @@@D31/12'09
	// MS Money 98: @@@D31/12'09
	// MS Money 99: @@@D31/12/09

	var i, newline, sep, parsedData, rows, rowDate, rowDateCentury, rowAmount, rowDescription, rowDocNumber, dateReplace;
	
	newline = /\r?\n/g;  // \r\n Windows, \n Linux/Mac
	sep = '@@@';
	parsedData = [];
	
	rawData = rawData.replace(newline, sep);
	rawData = rawData.replace(new RegExp(sep + '\\^', 'g'), '\n^');

	dateReplace = [];
	if (version == 'money97' || version == 'money98') {
		dateReplace = [
			/.*@@@D(\d\d)\/(\d\d)'(\d\d)@@@.*/,
			'$3-$2-$1'
		];
	} else if (version == 'money99') {
		dateReplace = [
			/.*@@@D(\d\d)\/(\d\d)\/(\d\d)@@@.*/,
			'$3-$2-$1'
		];
	} else if (version == 'quicken') {
		dateReplace = [
			/.*@@@D(\d\d)\/(\d\d)'(\d\d)@@@.*/,
			'$3-$1-$2'
		];
	}
	
	// Split lines
	rows = rawData.split('\n');
	
	for (i = 0; i < rows.length; i++) {

		rowDate = rowAmount = rowDocNumber = rowDescription = rowDateCentury = '';

		// ^@@@D04/07'09@@@T4.59@@@N0002313@@@MJUROS POUPANCA
		
		// Invalid Line
		if (rows[i].substring(0, 1) != '^') {
			continue;
		}
		if (rows[i].length < 10) {
			continue;
		}
		
		// @@@D31/12'09 or @@@D31/12/09 or @@@D12/31'09 --> 09-12-31
		rowDate = rows[i].replace(dateReplace[0], dateReplace[1]);
		if (rowDate.match(/^\d\d-\d\d-\d\d$/)) {
			// YY-MM-DD --> YYYY-MM-DD (where YYYY == 19* || 20*)
			// Our range: 1960 - 2059
			rowDateCentury = (rowDate.substring(0, 1) >= 6) ? '19' : '20';
			rowDate = rowDateCentury + rowDate;
		} else {
			rowDate = 'DATA_INVÁLIDA';
		}
	
		// @@@T4.59
		// @@@T-4.59
		rowAmount = rows[i].replace(/.*@@@T(-?[\d.]+)@@@.*/, '$1');
		if (rowAmount.indexOf(sep) != -1) {
			rowAmount = 'VALOR_INVÁLIDO';
		}
		
		// @@@N0002313
		rowDocNumber = rows[i].replace(/.*@@@N(\d+)@@@.*/, '$1');
		
		// @@@MJUROS POUPANCA
		rowDescription = rows[i].replace(/.*@@@M(.*)/, '$1');
		
		parsedData.push([
			rowDate,
			formatValue(rowAmount),
			formatDescription(rowDescription, rowDocNumber)
		].join(dataFieldSeparator));
	}
	return parsedData;
}

function convertMyMoneyLog(rawData) {
	var i, parsedData, rows, rowDate, rowAmount, rowTags, fields, rowDescription, rowCategories, rowAccount;
	
	// Reset the data holder
	parsedData = [];
	// Split lines
	rows = rawData.split(dataRecordSeparator);
	// Scan data rows
	for (i = 0; i < rows.length; i++) {
		rowDate = rowAmount = rowDescription = rowAccount = '';
		rowTags = [];
		rowCategories = [];

		// Preserve commented rows
		if (rows[i].indexOf(commentChar) === 0) {
			parsedData.push(rows[i]);
			continue;
		}
		// Preserve blank lines
		if (!rows[i].strip()) {
			parsedData.push('');
			continue;
		}

		// Separate fields
		fields = rows[i].split(dataFieldSeparator);
		
		rowDate = fields[0];
		rowAmount = fields[1];
		rowDescription = fields[2];
		rowCategories = fields[3];
		rowAccount = fields[4];
		
		// Account turns to Tag
		if (rowAccount) {
			rowTags.push(rowAccount);
		}
		// Categories turns to Tags
		if (rowCategories) {
			rowTags = rowTags.concat(rowCategories.split(/ *; */));
		}
		// Compose tags
		if (rowTags.length > 0) {
			rowTags = rowTags.join(dataTagSeparator) + dataTagTerminator;
		} else {
			rowTags = '';
		}
		
		parsedData.push([
			rowDate,
			formatValue(rowAmount),
			rowTags + formatDescription(rowDescription)
		].join(dataFieldSeparator));
	}
	return parsedData;
}

function convert() {
	var mode, rawData, parsedData;
	
	// Read input data
	rawData = document.getElementById('input_data').value;

	mode = document.getElementById('mode').value;
	if (mode == 'myml') {
		parsedData = convertMyMoneyLog(rawData);
	} else if (mode == 'money97' || mode == 'money98' || mode == 'money99' || mode == 'quicken') {
		parsedData = convertQIF(rawData, mode);
	} else if (mode == 'ofx') {
		parsedData = convertOFX(rawData);
	}
	
	// Save output
	document.getElementById('output_data').value = parsedData.join('\n');
}
</script>

</head>
<body>

<h2>Converta lançamentos para o formato do MoneyLog</h2>

<noscript>
<p style="color:red;background:yellow;padding:10px;">
	Ops! Seu navegador está sem JavaScript, sem ele não vai funcionar.
	</p>
</noscript>

<p><br></p>

<p>De:
	<select id="mode" onchange="convert();">
		<option value="quicken">Quicken (*.QIF)</option>
		<option value="money97">MS-Money 97 (*.QIF)</option>
		<option value="money98">MS-Money 98 (*.QIF)</option>
		<option value="money99">MS-Money 99 (*.QIF)</option>
		<option value="ofx">MS-Money/Finance (*.OFX)</option>
		<option value="myml">myMoneyLog</option>
	</select>
</p>
<blockquote><textarea id="input_data" rows="12" cols="80" onkeyup="convert();"></textarea></blockquote>

<p><br><br></p>

<p>Para: <a href="http://aurelio.net/moneylog">MoneyLog</a></p>

<blockquote>
	<textarea id="output_data" rows="12" cols="80"></textarea>
	<br><input id="usecommas" type="checkbox" onclick="convert();"> Forçar o uso de vírgulas nos valores
	<br><input id="lowerdesc" type="checkbox" onclick="convert();"> Forçar a descrição em minúsculas
	<br><input id="hidedocnumber" type="checkbox" onclick="convert();"> Descartar o Número do Documento
</blockquote>

<p><br><br></p>

<p>CONFIRA O RESULTADO. Este é um processo automático, pode haver falhas.</p>

</body>
</html>