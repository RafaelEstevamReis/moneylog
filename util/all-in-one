#!/bin/bash
# Aurelio Jargas, http://aurelio.net/moneylog/
#
# Script to join all the MoneyLog pieces in one singe HTML file.
# Besides joining the files into one, it also changes the necessary settings.
#
# Usage:
#	all-in-one [--lang XX] [components-to-embed]
#
# Examples:
#	all-in-one                   # Embed everything
#	all-in-one css js txt        # Embed everything
#	all-in-one --lang en         # Embed everything, english version
#	all-in-one css js            # Don't embed data, use external TXT
#	all-in-one --lang en css js  # English version, use external TXT


cd $(dirname "$0")

# Defaults
mode="css js txt"   # Any combination of css, js, txt
lang="pt"           # pt, en, es, ca. Use --lang to change it.

# Files
html_path="../moneylog.html"
txt_path="../moneylog.txt"

# Option --lang
if test "$1" = '--lang'
then
	lang=$2
	shift
	shift
fi

# Language adjustments
if test "$lang" != 'pt'
then
	txt_path="../moneylog-$lang.txt"
fi

# Get mode from command line (if any)
if test $# -gt 0
then
	mode="$*"
fi

# Handy tool to grep a variable contents
grepvar() {
	test "${2#*$1}" != "$2"
}

# This warning and instructions are for the all-in-one version only
warning='
	****************************************************************
	***                                                          ***
	***   DO NOT EDIT THIS FILE IN MS WORD, use Notepad          ***
	***   More info at http://aurelio.net/soft/moneylog/         ***
	***                                                          ***
	***   NÃO EDITE ESTE ARQUIVO NO WORD, use o Bloco de Notas   ***
	***   Mais informações em http://aurelio.net/moneylog/       ***
	***                                                          ***
	****************************************************************
'
instructions='
###################################################################
# English:                                                        #
#  - Put all your data below this box                             #
#  - Format:  YYYY-MM-DD  <tab>  Number  <tab>  Description       #
#  - Tags: Optional tags on Description: tag1,tag2|Description    #
#  - Tip: Escape special symbols: & < > becomes &amp; &lt; &gt;   #
#                                                                 #
# Português:                                                      #
#  - Coloque seu dados aqui embaixo                               #
#  - Formato:  AAAA-MM-DD  <tab>  Número  <tab>  Descrição        #
#  - Tags: Se quiser use tags na Descrição: tag1,tag2|Descrição   #
#  - Dica: Coloque os símbolos & < > como &amp; &lt; &gt;         #
#                                                                 #
###################################################################
'

# Patterns:
# <link rel="stylesheet" type="text/css" href="moneylog.css">
# <script type="text/javascript" src="moneylog.js"></script>

insert_css='
/^<link .*href="moneylog.css"/ {
	a \
<style type="text/css">
	r ../moneylog.css
	a \
</style>
	d
}
'
insert_js='
/^<script .*src="moneylog.js"/ {
	a \
<script type="text/javascript">
	r ../moneylog.js
	a \
</script>
	d
}
'
insert_warning='5 r temp1'
insert_txt='/^<pre/ r temp2'
change_lang="/^var lang = 'pt';/ s/pt/$lang/"

# Compose sed script
echo > sed_script
grepvar css "$mode" && echo "$insert_css" >> sed_script
grepvar js  "$mode" && echo "$insert_js"  >> sed_script
grepvar txt "$mode" && echo "$insert_txt" >> sed_script
grepvar txt "$mode" && echo "$insert_warning" >> sed_script

# Changes from Beta to All-in-one
change_script='
# Activate one-file mode
/^var appMode = .txt.;/ s/txt/one/

# Remove config.js call
/^<script .* src="config.js"><\/script>/ d

# Remove closing tags at the end
/^<\/pre>/, $ d
'

# Language must be changed?
if test $lang != 'pt'
then
	change_script="$change_script$change_lang"
fi

# Mode settings
if grepvar txt "$mode"
then
	# Warning on top
	echo "$warning" > temp1
	cat "$txt_path" > temp2

	# # Replace instructions on top of TXT file
	# echo "$instructions" > temp2
	# sed '1,5 { /^#/d; }' "$txt_path" >> temp2
else
	change_script='1 s/z/z/' # no changes
fi

# Do it
control_m=$(printf '\r');

sed -f sed_script "$html_path" |
 	sed "$change_script" |
	sed "s/$control_m*$/$control_m/"
	# unix2dos: Remove any CR, then add one per line, becoming CR+LF

# Clean up
rm -f temp1 temp2 sed_script
